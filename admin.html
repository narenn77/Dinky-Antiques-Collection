<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dinky's Admin Panel</title>
<style>
  body { font-family: sans-serif; margin: 0; }
  .hidden { display: none; }
  .container { display: flex; height: 100vh; }
  .sidebar { width: 220px; background: #deb887; padding: 20px; box-sizing: border-box; }
  .sidebar button { width: 100%; margin-bottom: 10px; padding: 10px; background: #c08040; border: none; color: white; cursor: pointer; }
  .sidebar button.active { background: #a06020; }
  .content { flex: 1; padding: 20px; box-sizing: border-box; overflow-y: auto; }
  form { max-width: 400px; }
  label { display: block; margin-top: 1em; }
  input, select, textarea { width: 100%; padding: 8px; margin-top: .5em; box-sizing: border-box; }
  button.save, button.cancel { margin-top: 1em; padding: 10px 20px; cursor: pointer; }
  button.cancel { margin-left: 10px; }
</style>
</head>
<body>

<div id="loginScreen" style="height: 100vh; display: flex; align-items:center; justify-content:center; background: #8b4513;">
  <form id="loginForm" style="background: white; padding: 30px; border-radius:10px;" onsubmit="login(event)">
    <h2>Admin Login</h2>
    <label>Username <input id="username" required></label>
    <label>Password <input id="password" type="password" required></label>
    <button type="submit">Login</button>
    <p style="color: #8b4513; margin-top: 10px;">Default: admin / admin123</p>
    <p id="loginError" style="color: red; display: none;">Invalid credentials</p>
  </form>
</div>

<div id="adminPanel" class="hidden container">
  <nav class="sidebar">
    <button class="active" data-section="dashboard">Dashboard</button>
    <button data-section="items">Items</button>
    <button data-section="countries">Countries</button>
    <button data-section="settings">Settings</button>
    <button style="margin-top: auto; background: #c03020;" id="logoutBtn">Logout</button>
  </nav>
  <main class="content">
    <section id="dashboard" class="section">Welcome to Dashboard</section>

    <section id="items" class="section hidden">
      <h2>Items</h2>
      <button onclick="showAddItem()">Add New Item</button>
      <ul id="itemList"></ul>
      <div id="itemFormContainer" class="hidden">
        <h3 id="itemFormTitle">Add Item</h3>
        <form id="itemForm" onsubmit="saveItem(event)">
          <label>Name: <input id="itemName" required></label>
          <label>Category:
            <select id="itemCategory" required>
              <option value="">Select</option>
              <option value="Stamp">Stamp</option>
              <option value="Coin">Coin</option>
            </select>
          </label>
          <label>Country:
            <select id="itemCountry" required></select>
          </label>
          <button class="save" type="submit">Save</button>
          <button class="cancel" type="button" onclick="cancelItemForm()">Cancel</button>
        </form>
      </div>
    </section>

    <section id="countries" class="section hidden">
      <h2>Countries</h2>
      <button onclick="showAddCountry()">Add New Country</button>
      <ul id="countryList"></ul>
      <div id="countryFormContainer" class="hidden">
        <h3 id="countryFormTitle">Add Country</h3>
        <form id="countryForm" onsubmit="saveCountry(event)">
          <label>Name: <input id="countryName" required></label>
          <button class="save" type="submit">Save</button>
          <button class="cancel" type="button" onclick="cancelCountryForm()">Cancel</button>
        </form>
      </div>
    </section>

    <section id="settings" class="section hidden">
      <h2>Settings</h2>
      <button onclick="exportData()">Export Data</button>
      <button onclick="document.getElementById('fileInput').click()">Import Data</button>
      <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importData(event)">
      <button onclick="clearData()">Clear All Data</button>
      <form onsubmit="changePassword(event)">
        <label>Current Password: <input type="password" id="currentPass"></label>
        <label>New Password: <input type="password" id="newPass"></label>
        <button type="submit">Change Password</button>
      </form>
    </section>
  </main>
</div>

<script>
  let currentItemEdit = null;
  let currentCountryEdit = null;

  const defaultPassword = 'admin123';

  function login(e) {
    e.preventDefault();
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value.trim();
    const error = document.getElementById('loginError');
    if(user === 'admin' && pass === (localStorage.getItem('adminPass')|| defaultPassword)) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminPanel').classList.remove('hidden');
      initializeApp();
    } else {
      error.style.display = 'block';
    }
  }

  function logout() {
    if(confirm('Logout?')) {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('adminPanel').classList.add('hidden');
      clearForms();
      currentItemEdit = null;
      currentCountryEdit = null;
    }
  }

  function initializeApp() {
    loadData();
    loadCountries();
    bindMenu();
    showSection('dashboard');
  }

  // Sidebar Menu
  function bindMenu() {
    document.querySelectorAll('.sidebar button[data-section]').forEach(btn => {
      btn.addEventListener('click', () => {
        const sec = btn.getAttribute('data-section');
        showSection(sec);
      });
    });
    document.getElementById('logoutBtn').addEventListener('click', logout);
  }

  function showSection(name) {
    document.querySelectorAll('main .section').forEach(s => s.classList.add('hidden'));
    document.getElementById(name).classList.remove('hidden');
    document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
    document.querySelector(`.sidebar button[data-section="${name}"]`).classList.add('active');
  }

  // Data Handling
  function loadData() {
    // Load items
    let data = localStorage.getItem('collection');
    if(data) window.collection = JSON.parse(data);
    else window.collection = { stamps: [], coins: [] };
    renderItemsList();
  }

  function saveData() {
    localStorage.setItem('collection', JSON.stringify(window.collection));
    renderItemsList();
  }

  function loadCountries() {
    let data = localStorage.getItem('countries');
    if(data) window.countries = JSON.parse(data);
    else window.countries = ['USA', 'UK', 'France', 'Germany', 'Japan'];
    renderCountryList();
  }

  function saveCountries() {
    localStorage.setItem('countries', JSON.stringify(window.countries));
    renderCountryList();
  }

  // Items
  function renderItemsList() {
    let ul = document.getElementById('itemList');
    ul.innerHTML = '';
    ['stamps', 'coins'].forEach(cat => {
      if(collection[cat]) {
        collection[cat].forEach(item => {
          let li = document.createElement('li');
          li.textContent = `${item.name} (${cat})`;
          let editBtn = document.createElement('button');
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', () => editItem(cat, item.id));
          let delBtn = document.createElement('button');
          delBtn.textContent = 'Delete';
          delBtn.addEventListener('click', () => deleteItem(cat, item.id));
          li.appendChild(editBtn);
          li.appendChild(delBtn);
          ul.appendChild(li);
        });
      }
    });
  }

  function showAddItem() {
    currentItemEdit = null;
    document.getElementById('itemForm').reset();
    showSection('add-item-section');
    populateCountryOptions();
  }

  function editItem(cat, id) {
    currentItemEdit = { cat, id };
    const item = collection[cat].find(i => i.id === id);
    if(!item) return alert('Item not found');
    document.getElementById('itemName').value = item.name;
    document.getElementById('itemCategory').value = cat;
    document.getElementById('itemYear').value = item.year;
    document.getElementById('itemCountry').value = item.country;
    document.getElementById('itemCondition').value = item.condition;
    document.getElementById('itemRarity').value = item.rarity;
    document.getElementById('itemImage').value = item.image || '';
    document.getElementById('itemDescription').value = item.description;
    document.getElementById('itemHistory').value = item.history || '';
    document.getElementById('itemNotes').value = item.notes || '';
    showSection('add-item-section');
    populateCountryOptions();
  }

  function saveItem(e) {
    e.preventDefault();
    const name = document.getElementById('itemName').value.trim();
    const cat = document.getElementById('itemCategory').value;
    if(!name || !cat) return alert('Name and category required.');
    let dataItem = {
      id: currentItemEdit ? currentItemEdit.id : (Date.now().toString()),
      name,
      category: cat,
      year: document.getElementById('itemYear').value.trim(),
      country: document.getElementById('itemCountry').value,
      condition: document.getElementById('itemCondition').value,
      rarity: document.getElementById('itemRarity').value,
      image: document.getElementById('itemImage').value.trim(),
      description: document.getElementById('itemDescription').value.trim(),
      history: document.getElementById('itemHistory').value.trim(),
      notes: document.getElementById('itemNotes').value.trim()
    };
    if(currentItemEdit) {
      // Update existing
      let idx = collection[currentItemEdit.cat].findIndex(i => i.id === currentItemEdit.id);
      if(idx !== -1) {
        if(currentItemEdit.cat === cat) {
          collection[cat][idx] = dataItem;
        } else {
          collection[currentItemEdit.cat].splice(idx,1);
          collection[cat].push(dataItem);
        }
      }
    } else {
      collection[cat].push(dataItem);
    }
    saveData();
    currentItemEdit = null;
    showSection('items');
  }

  function deleteItem(cat, id) {
    if(!confirm('Delete this item?')) return;
    let idx = collection[cat].findIndex(i => i.id === id);
    if(idx !== -1) {
      collection[cat].splice(idx,1);
      saveData();
    }
  }

  function cancelItemForm() {
    currentItemEdit = null;
    showSection('items');
  }

  // Countries
  function renderCountryList() {
    let ul = document.getElementById('countryList');
    ul.innerHTML = '';
    countries.forEach((c, idx) => {
      let li = document.createElement('li');
      li.textContent = c + ' ';
      let editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.addEventListener('click', () => editCountry(idx));
      let delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.addEventListener('click', () => deleteCountry(idx));
      li.appendChild(editBtn);
      li.appendChild(delBtn);
      ul.appendChild(li);
    });
  }

  function showAddCountry() {
    currentCountryEdit = null;
    document.getElementById('countryForm').reset();
    document.getElementById('countryForm').classList.remove('hidden');
    document.getElementById('countryList').classList.add('hidden');
  }

  function saveCountry(e) {
    e.preventDefault();
    const val = document.getElementById('countryName').value.trim();
    if(!val) return alert('Please enter a country name.');
    if(currentCountryEdit === null) {
      if(countries.includes(val)) return alert('Country already exists.');
      countries.push(val);
    } else {
      countries[currentCountryEdit] = val;
    }
    currentCountryEdit = null;
    saveCountries();
    renderCountryList();
    cancelCountryForm();
  }

  function cancelCountryForm() {
    document.getElementById('countryForm').classList.add('hidden');
    document.getElementById('countryList').classList.remove('hidden');
  }

  function editCountry(idx) {
    currentCountryEdit = idx;
    document.getElementById('countryName').value = countries[idx];
    document.getElementById('countryForm').classList.remove('hidden');
    document.getElementById('countryList').classList.add('hidden');
  }

  function deleteCountry(idx) {
    if(!confirm('Delete country?')) return;
    countries.splice(idx,1);
    saveCountries();
    renderCountryList();
  }

  // Helpers
  function populateCountryOptions() {
    let select = document.getElementById('itemCountry');
    select.innerHTML = '<option value="">Select country</option>';
    countries.forEach(c => {
      let opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      select.appendChild(opt);
    });
  }

  // Data functions
  function exportData() {
    if(!adminManager) return;
    let data = JSON.stringify(adminManager.collection, null, 2);
    let blob = new Blob([data], {type: "application/json"});
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'dinky-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function importData(e) {
    if(!adminManager) return;
    let f = e.target.files[0];
    if(!f) return;
    let reader = new FileReader();
    reader.onload = function(evt) {
      try {
        let data = JSON.parse(evt.target.result);
        if(!data.stamps || !data.coins || !data.currency) throw 'Invalid data';
        adminManager.collection = data;
        adminManager.saveData();
        adminManager.renderTable('stamps');
        adminManager.renderTable('coins');
        adminManager.renderTable('currency');
        adminManager.renderItemsList();
        alert('Data imported');
      } catch {
        alert('Invalid JSON file');
      }
      e.target.value = null;
    };
    reader.readAsText(f);
  }

  function clearData() {
    if(!adminManager) return;
    if(!confirm('Clear all data?')) return;
    adminManager.collection = { stamps: [], coins: [], currency: [] };
    adminManager.saveData();
    adminManager.renderTable('stamps');
    adminManager.renderTable('coins');
    adminManager.renderTable('currency');
    adminManager.renderItemsList();
  }

  function changePassword(e) {
    e.preventDefault();
    let current = document.getElementById('currentPass').value;
    let newp = document.getElementById('newPass').value;
    let saved = localStorage.getItem('adminPass') || 'admin123';
    if(current !== saved) return alert('Wrong current password');
    if(newp.length < 6) return alert('Password must be min 6 characters');
    localStorage.setItem('adminPass', newp);
    alert('Password changed');
    e.target.reset();
  }

  // Initialization
  let adminManager;

  document.querySelector('#loginForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value.trim();
    const error = document.getElementById('loginError');
    if(user === 'admin' && pass === (localStorage.getItem('adminPass') || 'admin123')) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'flex';
      adminManager = new AdminManager();
    } else {
      error.style.display = 'block';
    }
  });

</script>
</body>
</html>
